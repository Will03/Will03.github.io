---
title: Introduce GoFetch Vulnerability in Apple M-Series Chips
date: 2024-3-31 1:00:00 +0800
categories: [ Paper ]
tags: [ macos, apple ]     # TAG names should always be lowercase
---

<style>

.text-center{
    text-align: center; //æ–‡å­—ç½®ä¸­
}
.text-left{
    text-align: left; //æ–‡å­—é å·¦
}
.text-right{
    text-align: right; //æ–‡å­—é å³
}

</style>


## ğŸ“Œä»‹ç´¹

äº†è§£é€™å€‹æ‰‹æ³•å‰å…ˆä¾†èŠèŠèƒŒæ™¯ï¼Œåœ¨è˜‹æœçš„ macOS åš´æ ¼é™åˆ¶è¡Œç¨‹é–“æ˜¯ä¸èƒ½äº’ç›¸å­˜å–è¨˜æ†¶é«”å…§å®¹ï¼Œé™¤éæœ‰ç‰¹æ®Šçš„ entitlementã€‚è€Œæœ¬ç¯‡æƒ³æ¢è¨çš„å°±æ˜¯å˜—è©¦ç”¨ç¡¬é«”å…§çš„è¡Œç‚ºç¹éè»Ÿé«”é˜²è­·æ©Ÿåˆ¶é€é cache ä¾†ç«Šå–å…¶ç¨‹å¼çš„è¨˜æ†¶é«”å…§å®¹ã€‚

é‡å° cache çš„æ”»æ“Šæ›¾å‡ºéåƒæ˜¯ Meltdown å’Œ Spectreï¼Œè€Œé€™æ¬¡çš„æ¼æ´è™•åœ¨ Apple æ™¶ç‰‡çš„ DMP(Data Memory-Dependent Prefetchers)ï¼Œæ—¢ç„¶ä»–çš„åç¨±æœ‰å€‹ Prefetcher ä½ æ‡‰è©²å¯ä»¥çŒœåˆ°ä»–å°±æ˜¯ä¸€ç¨®é å…ˆè¼‰å…¥çš„æ©Ÿåˆ¶ã€‚

èˆ‡ä¸€èˆ¬ prefetcher ä¸åŒè™•åœ¨æ–¼ç•¶ä»–é‡åˆ°å…§å®¹æ˜¯æŒ‡æ¨™çš„æ™‚å€™æœƒå°‡æŒ‡æ¨™çš„è¨˜æ†¶é«” dereference(è§£åƒè€ƒ)å¾Œæ”¾é€² cacheï¼Œæ¸›å°‘ä¸‹ä¸€æ¬¡é‡åˆ°è¦è§£åƒè€ƒçš„æ™‚é–“ã€‚

![](/image/2024-03-31/1.png)

graph made by  `[3]`

ä¾‹å¦‚ç•¶ arr[n+1] æŒ‡å‘ä¸€å€‹ address æ™‚ï¼ŒDMP æœƒå„²å­˜ *arr[n+1]ã€‚

![](/image/2024-03-31/2.png)

graph made by `[3]`

## ğŸ“Œæ”»æ“Šæƒ…å¢ƒ

æ©Ÿåˆ¶æ‡‚äº†é‚£å°±ä¾†ç”¨ä½œè€…çµ¦çš„ç°¡å–®ç¯„ä¾‹ä¾†è¬›è§£ä¸€ä¸‹å§ï¼Œä»¥ä¸‹æ˜¯å—å®³è¡Œç¨‹åŸ·è¡Œçš„æ¼”ç®—æ³•ï¼Œåœ¨é€™é‚Šæ”»æ“Šè€…çš„ç›®çš„æ˜¯è©¦åœ–æ‰¾åˆ° secret çš„å…§å®¹ã€‚

```
void ct-swap(uint64_t secret, uint64_t *a, uint64_t *b, size_t len) {
    uint64_t delta;
    uint64_t mask = ~(secret-1);
    for (size_t i = 0; i < len; i++) {
            delta = (a[i] ^ b[i]) & mask;
            a[i] = a[i] ^ delta;
            b[i] = b[i] ^ delta;
    }
}
```

é¦–å…ˆæ”»æ“Šæƒ…å¢ƒä¸­ç¸½å…±æœ‰ä¸‰éš»è¡Œç¨‹ï¼Œæ”»æ“Šè€…å¯ä»¥è¦æ±‚åŠ å¯†è¡Œç¨‹é€²è¡ŒåŠ å¯†è«‹æ±‚ï¼Œä¸¦ä¸”æŒ‡å®šè¦åŠ å¯†çš„å…§å®¹(b or a)
â¢ Victim - è² è²¬åŸ·è¡Œ `ct-swap` çš„è¡Œç¨‹å…¶ä¸­åŒ…å« secret 
â¢ AttackerA - è² è²¬è«‹æ±‚ Victim åŸ·è¡Œ `ct-swap` ä»¥åŠæŒ‡å®š a æˆ–æ˜¯ b çš„å…§å®¹
â¢ AttackerB - è² è²¬åŸ·è¡Œç¶“å…¸çš„ Prime+Probe [1] æ”»æ“Šï¼Œç®—å‡ºå¦ä¸€å€‹é™£åˆ—çš„å…§å®¹

âš” æ”»æ“Šæµç¨‹ï¼š
1. æ”»æ“Šè€…éš¨æ©ŸæŒ‘é¸ a æˆ– b é™£åˆ—è¼¸å…¥ï¼ˆé€™é‚Šå‡è¨­ bï¼‰ï¼Œæ¥è‘—å°‡ b é™£åˆ—ä¸­çš„å…¶ä¸­ä¸€å€‹ä½ç½®å¡«å…¥ ptr (ptr æŒ‡çš„æ˜¯æ”»æ“Šè€…æ±ºå®šçš„è¨˜æ†¶é«”åœ°å€)
2. é–‹å§‹ ct-swap æ™‚ï¼Œæ”»æ“Šè€…è§€å¯Ÿæ˜¯å¦å› ç‚º a å’Œ b åœ¨åšäº¤æ›æ™‚è®“ a é™£åˆ—å‡ºç¾ ptrï¼Œç•¶ a é™£åˆ—å‡ºç¾ ptr æ™‚
3. å¥½ç©çš„å°±åœ¨é€™ï¼ŒDMP çš„æ©Ÿåˆ¶æœƒå› ç‚º a é™£åˆ—å‡ºç¾ ptr è€Œè§¸ç™¼ (å› ç‚ºé™£åˆ—ä¸­å‡ºç¾ addressï¼Œæ‰€ä»¥ DMP å°‡å…¶å…§å®¹æ”¾åˆ° cache)
4. ç„¶å¾Œæ”»æ“Šè€…ä½¿ç”¨å‚³çµ±çš„å¿«å–æ—è·¯æ”»æ“Šï¼ˆPrime+Probeï¼‰ä¾†è§€å¯Ÿ ptr æ˜¯å¦ç”±æ–¼ ct-swap å° a çš„è¨ˆç®—è€Œè¢« DMP è§£åƒè€ƒ
5. é€™æ¨£å¤šæ¬¡é‡è¤‡åŸ·è¡Œå¾Œ(3200 æ¬¡)å³å¯é€éæª¢æŸ¥åˆ†å¸ƒåœ–æ¨æ–· secret çš„å…§å®¹æ˜¯ 1 æˆ–æ˜¯ 0

![](/image/2024-03-31/3.png)

graph made by `[2]`


èªªåˆ°é€™é‚Šå¤§å®¶å¯èƒ½æœƒæœ‰å€‹ç–‘å•ï¼Œé˜¿æ”»æ“Šè€…æ§åˆ¶çš„ b é™£åˆ—åŸæœ¬çš„ ptr ä¹Ÿæœƒé€²åˆ° DMP cache å‘€ï¼Œé‚£æ€éº¼åˆ†è¾¨å“ªå€‹æ˜¯ä¾†è‡ª a é™£åˆ—çš„ cacheï¼Œå¯¦éš›ä¸Šåšè€…é‚„æœ‰é€éå…¶ä»–æ–¹å¼å°‡ a é™£åˆ—ä¸æ–·å¾ cache ç§»é™¤ï¼ˆevictingï¼‰ï¼Œä½†ç‚ºäº†ç¯‡å¹…å®¹æˆ‘çœç•¥é€™éƒ¨åˆ†ã€‚

## ğŸ“Œç¸½çµ

ç°¡å–®çš„è§£é‡‹å¤§æ¦‚æ˜¯é€™æ¨£ï¼Œè½å®Œæœ‰èˆˆè¶£çš„äººå¯ä»¥å˜—è©¦é–±è®€è£œå……çš„å…©ç¯‡è«–æ–‡ï¼Œå°±æœƒçœ‹åˆ° golang åŠ å¯†æ–¹å¼è¢«æ”»æ“Šçš„æ‰‹æ³•ï¼Œäº‹å¯¦ä¸Šé€™ä¸æ˜¯ç¬¬ä¸€æ¬¡é‡å° DMP çš„æ”»æ“Šï¼Œä½†å¯èƒ½æ˜¯ç›¸å°å®Œæ•´ï¼Œæˆ‘æœƒè¦ºå¾—é€™ç¨®æ–¹å¼é›¢ç©©å®šåœ¨å¯¦éš›æƒ¡æ„ç¨‹å¼ä¸ŠåŸ·è¡Œé‚„æœ‰ä¸€æ®µè·é›¢ã€‚

å·²ä½¿ç”¨è€…çš„è§’åº¦ä¾†èªªï¼Œå¾æ¯æ¬¡è˜‹æœå®‰å…¨æ›´æ–°çš„æ•¸é‡ä¾†çœ‹æˆ–è¨±çœŸçš„è©²æ“”å¿ƒçš„æ˜¯è»Ÿé«”æ‰€å°è‡´çš„æ¼æ´å§ğŸ˜†ï¼Œä½†é€™æˆ–è¨±ä¹Ÿæ˜¯å€‹è­¦ç¤ºåœ¨é€™å€‹ç¡¬é«”ä¸æ–·æ¨å±¤å‡ºæ–°ä¸”æ¶é€²ç¡¬é«”çš„å¸‚å ´æˆ–è¨±åœ¨ç¡¬é«”è®Šé©çš„åŒæ™‚ä¹Ÿéœ€è¦äº†è§£åŠ é€ŸèƒŒå¾Œçš„å®‰å…¨è€ƒé‡ã€‚

## ğŸ“ŒRef
- [1] Prime+Probe: æ˜¯ä¸€ç¨®å·²ç¶“è¡Œä¹‹æœ‰å¹´çš„æ”»æ“Šæ‰‹æ³•ï¼Œé€éä¸æ–·çš„å°‡ cache å¯«æ»¿ä¾†æª¢æŸ¥æ¯æ¬¡å“ªé‚Šæœ‰å‡ºç¾ cache miss ä¾†æ¨æ¸¬å…§å®¹
- [2] GoFetch: Breaking Constant-Time Cryptographic Implementations Using Data Memory-Dependent Prefetchers https://gofetch.fail/
- [3] Augury: Using Data Memory-Dependent Prefetchers to Leak Data at Rest https://ieeexplore.ieee.org/document/9833570/